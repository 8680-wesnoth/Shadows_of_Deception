#textdomain wesnoth-Shadows_of_Deception

[scenario]
    id=04_Pursuit
    name= _ "Pursuit"
    {MAP 04_Pursuit.map}
    turn=-1
    next_scenario=05_01_Ambush_in_Wesmere
    victory_when_enemies_defeated=no

    {UNDERGROUND}

    {SCENARIO_MUSIC       underground.ogg} {CONTINUE_PLAYING_STORY_MUSIC_FIRST}
    {EXTRA_SCENARIO_MUSIC franticsketch.ogg}
    {EXTRA_SCENARIO_MUSIC vengeful.ogg}
    {EXTRA_SCENARIO_MUSIC into_the_shadows.ogg}

    {STORYTXT_PURSUIT}

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        gold=60
        save_id=player
        team_name=good
        user_team_name= _ "team_name^Niryone"
        {ELVISH_FLAG}

        # wmllint: recognize Niryone
        {CHARACTER_STATS:NIRYONE}

        facing=ne
        shroud=yes
    [/side]

    [side]
        side=2
        controller=ai
        recruit=Giant Mudcrawler, Giant Scorpion, Skeleton, Skeleton Archer
        {GOLD 600 675 750}
        team_name=evil
        user_team_name= _ "team_name^Escort"
        type=Grand Marshal
        {HUMAN_FLAG}

        # wmllint: recognize RHAEN
        {CHARACTER_STATS:RHAEN}

        facing=se
        hidden=yes
        ai_special=guardian

        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT grouping          offensive}
            {AI_SIMPLE_ALWAYS_ASPECT caution           0.00}
            {AI_SIMPLE_ALWAYS_ASPECT aggression        2.0}
            {AI_SIMPLE_ALWAYS_ASPECT leader_aggression 1.5}
            {AI_SIMPLE_ALWAYS_ASPECT leader_value      3}

            [goal]
                name=target
                value=10
                [criteria]
                    side=1
                [/criteria]
            [/goal]
        [/ai]
    [/side]

    [side]
        side=3
        controller=ai
        recruit=Troll Whelp, Troll
        {GOLD 120 140 160}
        team_name=evil
        user_team_name= _ "team_name^Trolls"
        type=Troll Warrior
        {RAGGED_FLAG}

        income=6

        name= _ "Barag"
        id=Barag
        canrecruit=yes
        unrenamable=yes

        hidden=yes
        color=brown
        facing=se

        ai_special=guardian

        [unit]
            type=Troll Shaman
            id=Garag
            name= _ "Garag"
            x,y=12,21
            ai_special=guardian
            [modifications]
                {TRAIT_RESILIENT}
            [/modifications]

            {IS_LOYAL}
        [/unit]
    [/side]

    # Random cave enemies
    [side]
        side=4
        controller=null
        no_leader=yes
        team_name=evil
        user_team_name= _ "team_name^Cave Creatures"
        hidden=yes
        color=black

        {GENERIC_UNIT () Leech 12 40}
        {GENERIC_UNIT () Leech 22 22}
        {GENERIC_UNIT () Leech 8  25}
        {GENERIC_UNIT () Leech 20  9}
        {GENERIC_UNIT () Leech 9  12}
    [/side]
    # wmllint: validate-on

    {PLACE_IMAGE scenery/monolith3.png 17 29}

    {PLACE_IMAGE items/bones.png 19 18}
    {PLACE_IMAGE items/bones.png 25 13}

    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 (Troll) {DIFF 2 3 4} }

    [event]
        name=prestart

        # We store the list of x,y coords in an array so it can be iterated over
        # It seems redundant, but it's more elegant to do this than manually
        # set up the array with [set_variables]. Two duplicates
        [store_locations]
            x=6,30
            y=8,3
            variable=doppel_locs
        [/store_locations]

        # Store Rhaen's stats to generate the doppelgangers from, and remove him
        # from the map. We can't use [deactivate_and_serialize_sides] since that
        # tag sets the side's controller to null, preventing turn events from
        # occurring. Use [store_unit] instead
        [store_unit]
            [filter]
                side=2
                id=Rhaen
            [/filter]
            variable=boss_store
            kill=yes
            fire_event=no
        [/store_unit]

        [micro_ai]
            side=3
            ai_type=stationed_guardian
            action=add

            id=Garag
            distance=5
            guard_x,guard_y=12,13
            station_x,station_y=12,13
        [/micro_ai]

        # wmllint: recognize Elynia
        {RECALL_ELYNIA 6 41}

        # wmllint: recognize Anathryis
        {RECALL_ANATHRYIS 7 42}

        {MODIFY_UNIT (side=1) facing ne}
    [/event]

    [event]
        name=start

        {LOCK_VIEW}

        [delay]
            time=500
        [/delay]

        [move_unit_fake]
            type=Grand Marshal
            x=12,15
            y=39,36
            side=2
        [/move_unit_fake]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Elynia
            message= _ "There he goes - after him!"
        [/message]

        [message]
            speaker=Niryone
            message= _ "Hm... I know these tunnels. In years past they were known as 'Thieves' Alley'. Popular place among less than reputable characters, though a cave-in at the northern entrance eventually rendered it almost useless; it seems that human doesn't know that."
        [/message]

        [message]
            speaker=Anathryis
            message= _ "Probably bats, leeches, scorpions, the whole lot, down here by now. Trolls too, most likely."
        [/message]

        [message]
            speaker=Elynia
            message= _ "Great...."
        [/message]

        {UNLOCK_VIEW}

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Pursue Rhaen")}

            {OBJECTIVE_DEFEAT ( _ "Death of Niryone")}
            {OBJECTIVE_DEFEAT ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT ( _ "Death of Anathryis")}

            {OBJECTIVE_CARRYOVER 40}
        )}
    [/event]

    [event]
        name=moveto
        [filter]
            x,y=17,29
        [/filter]

        [message]
            speaker=narrator
            image=scenery/monolith3.png
            message= _ "Thieves' Alley
			
Konrad was here"
        [/message]
    [/event]

    [event]
        name=sighted
        [filter]
            id=Garag
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [delay]
            time=500
        [/delay]

        [remove_shroud]
            side=1
            x=6-14
            y=20-25
        [/remove_shroud]

        [scroll_to_unit]
            id=Garag
        [/scroll_to_unit]

        [message]
            speaker=second_unit
            message= _ "That troll is guarding the passage forward, and it doesn't look like he's going to move."
        [/message]

        [message]
            speaker=Garag
            message= _ "YOU NOT PASS!"
        [/message]

        [message]
            speaker=Barag
            # wmllint: local spelling elvses
            message= _ "Ah, it is the filthy elvses he warned us about! Garag! Do not let them past! This gold is very pleasing to me!"
        [/message]

        [message]
            speaker=Garag
            message= _ "I just said that!"
        [/message]

        [message]
            speaker=Niryone
            message= _ "(<i>grimly</i>) It appears he has bribed these trolls to keep us at bay. Very well, if they won't move, we shall have to take them out."
        [/message]

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Defeat the troll guard")}

            {OBJECTIVE_DEFEAT ( _ "Death of Niryone")}
            {OBJECTIVE_DEFEAT ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT ( _ "Death of Anathryis")}

            {OBJECTIVE_CARRYOVER 40}
        )}
    [/event]

    [event]
        name=die
        [filter]
            id=Garag
        [/filter]

        [remove_terrain_overlays]
            terrain=*^Xo
        [/remove_terrain_overlays]

        [message]
            speaker=Anathryis
            message= _ "We may move ahead!"
        [/message]

        [event]
            delayed_variable_substitution=no
            name="side 2 turn $($turn_number+1)"

            [fire_event]
                name=begin_boss_battle
                [primary_unit]
                    x,y=$x1,$y1
                [/primary_unit]
            [/fire_event]
        [/event]
    [/event]

#define INT_SET_POS_ON_ID _CONTAINER _ID _X _Y _FACING
    [if]
        {VARIABLE_LEXICAL_EQUALS {_CONTAINER}+".id" {_ID} }
        [then]
            [set_variables]
                name={_CONTAINER}
                mode=merge
                [value]
                    facing={_FACING}
                    x={_X}
                    y={_Y}
                [/value]
            [/set_variables]
        [/then]
    [/if]
#enddef

    [event]
        name=begin_boss_battle
        first_time_only=yes

        [fade_out_music][/fade_out_music]

        [sound]
            name=rumble.ogg
        [/sound]

        {BLACK_SCREEN}

        [message]
            speaker=Elynia
            message= _ "What the-"
        [/message]

        [if]
            [have_unit]
                side=3
            [/have_unit]
            [then]
                [kill]
                    side=3
                    fire_event=no
                    animate=no
                [/kill]

                [message]
                    speaker=narrator
                    image=misc/blank-hex.png
                    message= _ "As the cavern was plunged into darkness, the remaining trolls fled."
                [/message]
            [/then]
        [/if]

        [message]
            speaker=narrator
            caption= _ "Voice from the dark"
            image=misc/blank-hex.png
            message= _ "So, am I cornered. You may capture me, but rest assured it will not be without a fight! You aren't the only one with fancy tricks up your sleeve, elf. Just wait and see..."
        [/message]

        [store_unit]
            [filter]
                side=1
                role=hero
                [not]
                    x,y=recall,recall
                [/not]
            [/filter]
            variable=heroes_store
            kill=yes
            fire_event=no
        [/store_unit]

        #[hide_unit]
        #    side=4
        #[/hide_unit]

        {FOREACH doppel_locs i}
            [hidden_unit]
                side=2
                x,y=$doppel_locs[$i].x,$doppel_locs[$i].y
                type=$boss_store.type
                id="doppelganger_$($i+1)" # So their IDs are 1 and 2 not 0 and 1
                name=$boss_store.name
                experience=$boss_store.experience
                profile=$boss_store.profile
                canrecruit=yes
                ai_special=guardian
            [/hidden_unit]
        {NEXT i}

        [delay]
            time=3000
        [/delay]

        [sound]
            name=lightning.ogg
        [/sound]

        {CLEAR_CAVE_SHROUD ()}

        #[remove_shroud]
        #    side=1
        #    x=8-17,17-28
        #    y=1-13,7-13
        #[/remove_shroud]

        [redraw]
            side=1
        [/redraw]

        # Scroll up
        [scroll_to]
            x,y=17,14
        [/scroll_to]

        {FADE_IN}

        {FOREACH heroes_store k}
            {INT_SET_POS_ON_ID heroes_store[$k] Niryone   13 18 ne}

            {INT_SET_POS_ON_ID heroes_store[$k] Elynia    12 18 ne}

            {INT_SET_POS_ON_ID heroes_store[$k] Anathryis 14 18 ne}

            [set_variables]
                name="heroes_store[$k]"
                mode=merge
                [value]
                    hitpoints=$heroes_store[$k].max_hitpoints
                    moves=$heroes_store[$k].max_moves
                    attacks_left=$heroes_store[$k].max_attacks
                [/value]
            [/set_variables]

            {CLEAR_VARIABLE heroes_store[$k].status.uncovered}
            {CLEAR_VARIABLE heroes_store[$k].status.poisoned}
            {CLEAR_VARIABLE heroes_store[$k].status.slowed}
            {CLEAR_VARIABLE heroes_store[$k].status.petrified}

            [unstore_unit]
                variable="heroes_store[$k]"
            [/unstore_unit]
        {NEXT k}

        [unstore_unit]
            variable=boss_store
        [/unstore_unit]

        [unhide_unit]
            side=2
        [/unhide_unit]

        {INCIDENTAL_MUSIC ambuscade.ogg}

        [redraw][/redraw]

        # Table of locations of him and his doppelgangers
        [store_locations]
            [filter]
                type=$boss_store.type
            [/filter]
            variable=badguy_locs
        [/store_locations]

        {VARIABLE_RANDOM id_fix_index (1..$badguy_locs.length)}

        {LOG_NX_DBG ("Index randomized to" + $id_fix_index + ". Real loc is " + $boss_store.x,$boss_store.y)}

        {FOREACH badguy_locs i}
            {VARIABLE index_inc ("$($i+1)")}

            {LOG_NX_DBG ("index_inc is " + $index_inc)}

            [scroll_to]
                x,y=$badguy_locs[$i].x,$badguy_locs[$i].y
            [/scroll_to]

            # Randomizes which Rhaen is the real one through a simple id change. Since theres no point
            # in changing anything if the unit randomized is already the real one, the filter excludes
            # any unit at the same coords as the real one, and checks if the current index  matches the
            # id_fix_index, meaning we're currently iterating over the appropriately chosen unit.
            # The proxy table still contains his original location, so we can use that here
            [if]
                {VARIABLE_NUMERICAL_NOT_EQUALS badguy_locs[$i].x  $boss_store.x}
                {VARIABLE_NUMERICAL_NOT_EQUALS badguy_locs[$i].y  $boss_store.y}
                {VARIABLE_NUMERICAL_EQUALS     index_inc          $id_fix_index}
                [then]
                    {MODIFY_UNIT (id=doppelganger_$index_inc)                     id Rhaen}
                    {MODIFY_UNIT (x,y=$boss_store.x,$boss_store.y)  id doppelganger_$index_inc}
                [/then]
            [/if]

            [delay]
                time=750
            [/delay]
        {NEXT i}

        # Clean up all the crud from setting up side 2
        {CLEAR_VARIABLE heroes_store,boss_store,doppel_locs,badguy_locs,id_fix_index,index_inc}

        [message]
            speaker=Anathryis
            message= _ "By the gods, what has he done..."
        [/message]

        # Captain obvious
        [message]
            speaker=Niryone
            message= _ "(<i>troubled</i>) He appears to have replicated himself. But he is no mage or necromancer; how did he come across this power?"
        [/message]

        [message]
            speaker=doppelganger_2
            message= _ "You think you're a hero, but you're only a self-absorbed, wose-born wench who delights in making points with other people's lives!"
        [/message]

        [message]
            speaker=doppelganger_1
            message= _ "Soon, things will be different... Soon! that damned fool of a King cannot stop it, you cannot stop it! But you are an elf, a member of the Council... what cause have you to be invested in our little scheme?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Do we really have to listen to the crazed ramblings of this madman? Can he even tell us what we want to know?"
        [/message]

        [message]
            speaker=Anathryis
            message= _ "There’s nowhere else to go! Just give us the answers we want and you may walk out of here with your life."
        [/message]

        [message]
            speaker=Rhaen
            message= _ "I am not so easily won! Though how do you even know..."
        [/message]

        [message]
            speaker=doppelganger_1
            message= _ "...this is really me talking?"
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Niryone
            message= _ "Then you leave us no choice, sorcerer. We will strike every shade down until naught one but you remain!"
        [/message]

        #[end_turn][/end_turn]

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Defeat the real Rhaen")}

            {OBJECTIVE_DEFEAT ( _ "Death of Niryone")}
            {OBJECTIVE_DEFEAT ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT ( _ "Death of Anathryis")}

            {OBJECTIVE_CARRYOVER 40}

            {OBJECTIVE_NOTES ( _ "Rhean does not need to be Bound this scenario")}
        )}
    [/event]

    [event]
        name=last breath
        [filter]
            id=Rhaen
        [/filter]

        [message]
            speaker=Rhaen
            message= _ "AAAAGGGGHHHH You...you..."
        [/message]

        [if]
            [not]
                [have_unit]
                    id=Niryone
                    [filter_adjacent]
                        id=Rhaen
                    [/filter_adjacent]
                [/have_unit]
            [/not]
            [then]
                [store_locations]
                    [filter]
                        id=Rhaen
                    [/filter]
                    variable=niry_move_here
                [/store_locations]

                [move_unit]
                    id=Niryone
                    x,y=$niry_move_here.x,$niry_move_here.y
                [/move_unit]

                {CLEAR_VARIABLE niry_move_here}
            [/then]
        [/if]

        {FACE_UNIT (id=Niryone) (id=Rhaen)}

        [message]
            speaker=Niryone
            message= _ "Tell me NOW! Who sent you and your transport, and where were you going? We know Myris in Elensefar is an impostor, and you display a surprising aptitude for replicates..."
        [/message]

        [message]
            speaker=Rhaen
            message= _ "(<i>panting</i>) You think... you know... anything. You think this is the work of some... invader... some cultist or lich. All of you, so secure in your hierarchy... Humans, elves, you will ALL see once he... once he... "
        [/message]

        [message]
            speaker=narrator
            image=misc/blank-hex.png
            message= _ "The human doubled over and coughed violently, drops of red splattering the cave floor."
        [/message]

        [message]
            speaker=Niryone
            message= _ "Who. Is. HE?!"
        [/message]

        # TODO: animate magic blast
        [message]
            speaker=narrator
            image=misc/blank-hex.png
            message= _ "Niryone is supposed to blast Rhaen with magic here, but the author is too lazy to code that right now. Please check back later for blasting."
        [/message]

        [message]
            speaker=Rhaen
            # wmllint: local spelling AAAAHHHHHHHHHH
            message= _ "(<span size='large'><i>AAAAHHHHHHHHHH!!!</i>) ... MIZENWYN!!</span>"
        [/message]

        {FLASH_WHITE (
            [message]
                speaker=narrator
                image=misc/blank-hex.png
                message= _ "Gasping in pain from the blast of energy, Rhaen collapsed to the ground. Niryone grimly waved her staff. A bright white light grew from its tip, filling the gloom with a searing radiance. When it cleared, their captive was gone."
            [/message]
        )}
    [/event]

    [event]
        name=die
        [filter]
            id=Rhaen
        [/filter]

        [delay]
            time=2000
        [/delay]

        [message]
            speaker=Elynia
            message= _ "Where... where did you send him...?"
        [/message]

        [message]
            speaker=Niryone
            message= _ "Somewhere he'll get his just reward."
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Niryone
            message= _ "And we must meet with the Ka’lian. Immediately. For once I think they will take an interest in my news."
        [/message]

        {ENDLEVEL_CONTINUE}
    [/event]

    # Dialog for the doppelgangers
    [event]
        name=last breath
        [filter]
            id=doppelganger_1
        [/filter]

        [message]
            speaker=unit
            message= _ "For someone they speak of as so intelligent, you really lack perception."
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=doppelganger_2
        [/filter]

        [message]
            speaker=unit
            message= _ "Tick tock, tick tock, elf. You chose wrongly."
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Barag
        [/filter]

        [message]
            speaker=unit
            message= _ "Nasty elvses kill Barag! (<i>Ugh....</i>)"
        [/message]
    [/event]

    [event]
        name=victory
    [/event]

    {B_HERO_DEATHS}
[/scenario]

#undef INT_SET_POS_ON_ID
